{% extends 'base.html' %}

{% block title %}{{ view.object.pk|yesno:'แก้ไข,เพิ่ม' }} บันทึกการสอบเทียบ Balance - {{ object.machine.name|default:'เครื่องมือ' }}{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8">
                <h1 class="page-title">
                    <i class="fas fa-balance-scale fa-lg"></i>
                    {{ view.object.pk|yesno:'แก้ไข,เพิ่ม' }} บันทึกการสอบเทียบ Balance
                </h1>
                <p class="page-subtitle">
                    {% if object.machine %}
                        {{ object.machine.name }} - {{ object.machine.machine_type.name }}
                    {% else %}
                        เลือกเครื่องมือเพื่อบันทึกการสอบเทียบ
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<div class="main-content">
    <div class="container-fluid">
        <!-- ข้อมูลเครื่องมือ -->
        {% if object.machine %}
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    ข้อมูลเครื่องมือ
                </h6>
            </div>
            <div class="card-body py-2">
                <div class="row">
                    <div class="col-md-3">
                        <small><strong>ชื่อ:</strong> {{ object.machine.name }}</small>
                    </div>
                    <div class="col-md-3">
                        <small><strong>รุ่น:</strong> {{ object.machine.model|default:"-" }}</small>
                    </div>
                    <div class="col-md-3">
                        <small><strong>หมายเลข:</strong> {{ object.machine.serial_number|default:"-" }}</small>
                    </div>
                    <div class="col-md-3">
                        <small><strong>ประเภท:</strong> {{ object.machine.machine_type.name }}</small>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- ฟอร์มบันทึกการสอบเทียบ -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-clipboard-list me-2"></i>
                    ข้อมูลการสอบเทียบ Balance
                </h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <!-- ข้อมูลทั่วไป -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="{{ form.date_calibration.id_for_label }}" class="form-label">
                                <i class="fas fa-calendar me-1"></i>{{ form.date_calibration.label }}
                            </label>
                            {{ form.date_calibration }}
                            {% if form.date_calibration.errors %}
                                <div class="text-danger small">{{ form.date_calibration.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-3">
                            <label for="{{ form.received_date.id_for_label }}" class="form-label">
                                <i class="fas fa-calendar-plus me-1"></i>{{ form.received_date.label }}
                            </label>
                            {{ form.received_date }}
                            {% if form.received_date.errors %}
                                <div class="text-danger small">{{ form.received_date.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-3">
                            <label for="{{ form.issue_date.id_for_label }}" class="form-label">
                                <i class="fas fa-calendar-check me-1"></i>{{ form.issue_date.label }}
                            </label>
                            {{ form.issue_date }}
                            {% if form.issue_date.errors %}
                                <div class="text-danger small">{{ form.issue_date.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-3">
                            <label for="{{ form.next_due.id_for_label }}" class="form-label">
                                <i class="fas fa-calendar-times me-1"></i>{{ form.next_due.label }}
                            </label>
                            {{ form.next_due }}
                            {% if form.next_due.errors %}
                                <div class="text-danger small">{{ form.next_due.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="{{ form.calibrator.id_for_label }}" class="form-label">
                                <i class="fas fa-user-cog me-1"></i>{{ form.calibrator.label }}
                            </label>
                            {{ form.calibrator }}
                            {% if form.calibrator.errors %}
                                <div class="text-danger small">{{ form.calibrator.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.certificate_issuer.id_for_label }}" class="form-label">
                                <i class="fas fa-user-tie me-1"></i>{{ form.certificate_issuer.label }}
                            </label>
                            {{ form.certificate_issuer }}
                            {% if form.certificate_issuer.errors %}
                                <div class="text-danger small">{{ form.certificate_issuer.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.machine.id_for_label }}" class="form-label">
                                <i class="fas fa-tools me-1"></i>{{ form.machine.label }}
                            </label>
                            {{ form.machine }}
                            {% if form.machine.errors %}
                                <div class="text-danger small">{{ form.machine.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.certificate_number.id_for_label }}" class="form-label">
                                <i class="fas fa-certificate me-1"></i>{{ form.certificate_number.label }}
                            </label>
                            {{ form.certificate_number }}
                            {% if form.certificate_number.errors %}
                                <div class="text-danger small">{{ form.certificate_number.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.procedure_number.id_for_label }}" class="form-label">
                                <i class="fas fa-list-ol me-1"></i>{{ form.procedure_number.label }}
                            </label>
                            {{ form.procedure_number }}
                            {% if form.procedure_number.errors %}
                                <div class="text-danger small">{{ form.procedure_number.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">
                                <i class="fas fa-tools me-1"></i>เครื่องมือที่ใช้สอบเทียบ
                            </label>
                            <div id="calibration-equipment-container">
                                <div class="row mb-2 calibration-equipment-row">
                                    <div class="col-md-10">
                                        <select name="{{ form.uuc_id.name }}" id="{{ form.uuc_id.id_for_label }}" class="form-control">
                                            <option value="">เลือกเครื่องมือที่ใช้สอบเทียบ</option>
                                            {% for equipment in form.uuc_id.field.queryset %}
                                                <option value="{{ equipment.id }}" {% if form.uuc_id.value == equipment.id %}selected{% endif %}>
                                                    {{ equipment.name }}-{{ equipment.model|default:"" }}-{{ equipment.serial_number|default:"" }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        {% if form.uuc_id.errors %}
                                            <div class="text-danger small">{{ form.uuc_id.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-success btn-sm add-equipment-btn">
                                            <i class="fas fa-plus"></i> เพิ่มเครื่องมือ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ตารางการสอบเทียบ Balance -->
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>Drift</th>
                                    <th>RES.ดัน</th>
                                    <th>RES.ปลาย</th>
                                    <th>Air Buoyancy</th>
                                    <th>Uncer 68%</th>
                                    <th>95%*K</th>
                                    <th>Final Uncer</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        {{ form.drift }}
                                        {% if form.drift.errors %}
                                            <div class="text-danger small mt-1">{{ form.drift.errors.0 }}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ form.res_push }}
                                        {% if form.res_push.errors %}
                                            <div class="text-danger small mt-1">{{ form.res_push.errors.0 }}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ form.res_tip }}
                                        {% if form.res_tip.errors %}
                                            <div class="text-danger small mt-1">{{ form.res_tip.errors.0 }}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ form.air_buoyancy }}
                                        {% if form.air_buoyancy.errors %}
                                            <div class="text-danger small mt-1">{{ form.air_buoyancy.errors.0 }}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ form.uncertainty_68 }}
                                        {% if form.uncertainty_68.errors %}
                                            <div class="text-danger small mt-1">{{ form.uncertainty_68.errors.0 }}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ form.uncertainty_95_k }}
                                        {% if form.uncertainty_95_k.errors %}
                                            <div class="text-danger small mt-1">{{ form.uncertainty_95_k.errors.0 }}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ form.final_uncertainty }}
                                        {% if form.final_uncertainty.errors %}
                                            <div class="text-danger small mt-1">{{ form.final_uncertainty.errors.0 }}</div>
                                        {% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Linear (Min-Max) -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-balance-scale me-2"></i>
                                Linear (Min-Max)
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Nominal Value (g)</th>
                                            <th>Conventional Mass (g)</th>
                                            <th>Displayed Value (g)</th>
                                            <th>Error (g)</th>
                                            <th>Uncertainty (g)</th>
                                            <th>Tolerance Limit</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                {{ form.linear_nominal_value }}
                                                {% if form.linear_nominal_value.errors %}
                                                    <div class="text-danger small">{{ form.linear_nominal_value.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.linear_conventional_mass }}
                                                {% if form.linear_conventional_mass.errors %}
                                                    <div class="text-danger small">{{ form.linear_conventional_mass.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.linear_displayed_value }}
                                                {% if form.linear_displayed_value.errors %}
                                                    <div class="text-danger small">{{ form.linear_displayed_value.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.linear_error }}
                                                {% if form.linear_error.errors %}
                                                    <div class="text-danger small">{{ form.linear_error.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.linear_uncertainty }}
                                                {% if form.linear_uncertainty.errors %}
                                                    <div class="text-danger small">{{ form.linear_uncertainty.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.linear_tolerance_limit }}
                                                {% if form.linear_tolerance_limit.errors %}
                                                    <div class="text-danger small">{{ form.linear_tolerance_limit.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="alert alert-info">
                                <small>
                                    <strong>หมายเหตุ:</strong> ช่องที่ 2 กับ 3 ห้ามเกินจากช่องที่ 1 ± 0.0003 ถ้าช่อง 2 กับ 3 เกิน ให้ผลสอบเทียบไม่ผ่าน
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- ตารางข้อมูลการอ่านค่า Balance Reading -->
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>UUC Set</th>
                                    <th>Conventional Mass</th>
                                    <th>Displayed Value</th>
                                    <th>Error</th>
                                    <th>Uncertainty</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <input type="text" class="form-control form-control-sm" placeholder="UUC Set" name="uuc_set">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" placeholder="Conventional Mass" name="conventional_mass" step="0.000001">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" placeholder="Displayed Value" name="displayed_value" step="0.000001">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" placeholder="Error" name="error" step="0.000001" readonly>
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" placeholder="Uncertainty" name="uncertainty" step="0.000001">
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="text" class="form-control form-control-sm" placeholder="UUC Set" name="uuc_set_2">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" placeholder="Conventional Mass" name="conventional_mass_2" step="0.000001">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" placeholder="Displayed Value" name="displayed_value_2" step="0.000001">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" placeholder="Error" name="error_2" step="0.000001" readonly>
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" placeholder="Uncertainty" name="uncertainty_2" step="0.000001">
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="text" class="form-control form-control-sm" placeholder="UUC Set" name="uuc_set_3">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" placeholder="Conventional Mass" name="conventional_mass_3" step="0.000001">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" placeholder="Displayed Value" name="displayed_value_3" step="0.000001">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" placeholder="Error" name="error_3" step="0.000001" readonly>
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" placeholder="Uncertainty" name="uncertainty_3" step="0.000001">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="btn-group">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-1"></i>บันทึกการสอบเทียบ
                                </button>
                                <a href="{% url 'calibrate-dashboard' %}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left me-1"></i>กลับไปรายการ
                                </a>
                                {% if object.pk %}
                                <a href="#" class="btn btn-danger" onclick="confirmDelete()">
                                    <i class="fas fa-trash me-1"></i>ลบ
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// JavaScript สำหรับเพิ่มเครื่องมือที่ใช้สอบเทียบ
let equipmentCounter = 1;

document.addEventListener('click', function(e) {
    if (e.target.classList.contains('add-equipment-btn')) {
        equipmentCounter++;
        const container = document.getElementById('calibration-equipment-container');
        const newRow = document.createElement('div');
        newRow.className = 'row mb-2 calibration-equipment-row';
        newRow.innerHTML = `
            <div class="col-md-10">
                <select name="uuc_id_${equipmentCounter}" class="form-control">
                    <option value="">เลือกเครื่องมือที่ใช้สอบเทียบ</option>
                    {% for equipment in form.uuc_id.field.queryset %}
                        <option value="{{ equipment.id }}">{{ equipment.name }}-{{ equipment.model|default:"" }}-{{ equipment.serial_number|default:"" }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-danger btn-sm remove-equipment-btn">
                    <i class="fas fa-minus"></i> ลบ
                </button>
            </div>
        `;
        container.appendChild(newRow);
    }
    
    if (e.target.classList.contains('remove-equipment-btn')) {
        e.target.closest('.calibration-equipment-row').remove();
    }
});

function confirmDelete() {
    if (confirm('คุณแน่ใจหรือไม่ที่จะลบข้อมูลการสอบเทียบนี้?')) {
        // เพิ่ม URL สำหรับลบข้อมูล
        window.location.href = '#';
    }
}

function addReading() {
    // เปิด modal หรือ redirect ไปหน้าเพิ่มข้อมูลการอ่านค่า
    alert('ฟีเจอร์เพิ่มข้อมูลการอ่านค่าจะเปิดใช้งานในอนาคต');
}

// คำนวณ Error อัตโนมัติ
function calculateError(displayedInput, conventionalInput, errorInput) {
    const displayed = parseFloat(displayedInput.value);
    const conventional = parseFloat(conventionalInput.value);
    
    if (!isNaN(displayed) && !isNaN(conventional)) {
        const error = displayed - conventional;
        errorInput.value = error.toFixed(6);
    } else {
        errorInput.value = '';
    }
}

// เพิ่ม event listeners สำหรับการคำนวณ Error
document.addEventListener('DOMContentLoaded', function() {
    // คำนวณ Error สำหรับแถวที่ 1
    const displayed1 = document.querySelector('input[name="displayed_value"]');
    const conventional1 = document.querySelector('input[name="conventional_mass"]');
    const error1 = document.querySelector('input[name="error"]');
    
    if (displayed1 && conventional1 && error1) {
        displayed1.addEventListener('input', () => calculateError(displayed1, conventional1, error1));
        conventional1.addEventListener('input', () => calculateError(displayed1, conventional1, error1));
    }
    
    // คำนวณ Error สำหรับแถวที่ 2
    const displayed2 = document.querySelector('input[name="displayed_value_2"]');
    const conventional2 = document.querySelector('input[name="conventional_mass_2"]');
    const error2 = document.querySelector('input[name="error_2"]');
    
    if (displayed2 && conventional2 && error2) {
        displayed2.addEventListener('input', () => calculateError(displayed2, conventional2, error2));
        conventional2.addEventListener('input', () => calculateError(displayed2, conventional2, error2));
    }
    
    // คำนวณ Error สำหรับแถวที่ 3
    const displayed3 = document.querySelector('input[name="displayed_value_3"]');
    const conventional3 = document.querySelector('input[name="conventional_mass_3"]');
    const error3 = document.querySelector('input[name="error_3"]');
    
    if (displayed3 && conventional3 && error3) {
        displayed3.addEventListener('input', () => calculateError(displayed3, conventional3, error3));
        conventional3.addEventListener('input', () => calculateError(displayed3, conventional3, error3));
    }
    
    // คำนวณ Linear Error และ Tolerance
    const linearDisplayed = document.querySelector('input[name="linear_displayed_value"]');
    const linearConventional = document.querySelector('input[name="linear_conventional_mass"]');
    const linearError = document.querySelector('input[name="linear_error"]');
    const linearTolerance = document.querySelector('input[name="linear_tolerance_limit"]');
    
    function calculateLinearError() {
        if (linearDisplayed && linearConventional && linearError) {
            const displayed = parseFloat(linearDisplayed.value) || 0;
            const conventional = parseFloat(linearConventional.value) || 0;
            const error = displayed - conventional;
            linearError.value = error.toFixed(5);
            
            // Calculate tolerance limit
            if (linearTolerance) {
                const nominal = parseFloat(document.querySelector('input[name="linear_nominal_value"]').value) || 0;
                const minTolerance = (nominal - 0.0003).toFixed(4);
                const maxTolerance = (nominal + 0.0003).toFixed(4);
                linearTolerance.value = `${minTolerance} – ${maxTolerance}`;
            }
        }
    }
    
    if (linearDisplayed && linearConventional) {
        [linearDisplayed, linearConventional].forEach(input => {
            input.addEventListener('input', calculateLinearError);
        });
    }
});
</script>

<style>
/* ซ่อนฟิลด์ที่ไม่ได้ใช้ */
#id_status, #id_priority, #id_update {
    display: none !important;
}

label[for="id_status"], label[for="id_priority"], label[for="id_update"] {
    display: none !important;
}

/* ซ่อน div ที่มีฟิลด์เหล่านี้ */
.col-md-3:has(#id_status), .col-md-3:has(#id_priority), .col-md-3:has(#id_update) {
    display: none !important;
}
</style>
{% endblock %}


