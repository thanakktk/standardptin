{% extends 'base.html' %}

{% block title %}หน้าหลักการปรับเทียบ{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8">
                <h1 class="page-title">
                    <i class="fas fa-clipboard-check fa-lg"></i>
                    หน้าหลักการปรับเทียบ
                </h1>
                <p class="page-subtitle">จัดการบันทึกการปรับเทียบเครื่องมือวัด</p>
            </div>
        </div>
    </div>
</div>

<div class="main-content">
    <div class="container-fluid">
        <!-- สถิติการปรับเทียบ -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="stats-icon bg-primary">
                        <i class="fas fa-weight"></i>
                    </div>
                    <div class="stats-content">
                        <h3>{{ force_calibrations_count }}</h3>
                        <p>บันทึกการปรับเทียบแรง</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="stats-icon bg-success">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <div class="stats-content">
                        <h3>{{ pressure_calibrations_count }}</h3>
                        <p>บันทึกการปรับเทียบความดัน</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="stats-icon bg-warning">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div class="stats-content">
                        <h3>{{ torque_calibrations_count }}</h3>
                        <p>บันทึกการปรับเทียบแรงบิด</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="stats-icon bg-secondary">
                        <i class="fas fa-ruler"></i>
                    </div>
                    <div class="stats-content">
                        <h3>{{ dial_gauge_calibrations_count }}</h3>
                        <p>บันทึกการปรับเทียบ Dial Gauge</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="stats-icon bg-dark">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <div class="stats-content">
                        <h3>{{ balance_calibrations_count }}</h3>
                        <p>บันทึกการปรับเทียบ Balance</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card">
                    <div class="stats-icon bg-danger">
                        <i class="fas fa-satellite-dish"></i>
                    </div>
                    <div class="stats-content">
                        <h3>{{ microwave_calibrations_count }}</h3>
                        <p>บันทึกการปรับเทียบ Microwave</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- สถิติรอการปรับเทียบ -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="stats-card">
                    <div class="stats-icon bg-info">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stats-content">
                        <h3>{{ pending_calibrations_count }}</h3>
                        <p>รอการปรับเทียบทั้งหมด</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search และ Filter -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="fas fa-search me-2"></i>
                            ค้นหาและกรองข้อมูล
                        </h5>
                    </div>
                    <div class="card-body">
                        <form method="get" id="searchForm">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">
                                        <i class="fas fa-search me-1"></i>ค้นหาชื่อเครื่องมือ
                                    </label>
                                    <input type="text" class="form-control" name="name_search" 
                                           value="{{ request.GET.name_search }}" placeholder="ชื่อเครื่องมือ...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">
                                        <i class="fas fa-barcode me-1"></i>ค้นหา Serial Number
                                    </label>
                                    <input type="text" class="form-control" name="serial_search" 
                                           value="{{ request.GET.serial_search }}" placeholder="Serial Number...">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">
                                        <i class="fas fa-tag me-1"></i>ประเภทการปรับเทียบ
                                    </label>
                                    <select class="form-control" name="calibration_type">
                                        <option value="">ทั้งหมด</option>
                                        <option value="force" {% if request.GET.calibration_type == 'force' %}selected{% endif %}>แรง</option>
                                        <option value="pressure" {% if request.GET.calibration_type == 'pressure' %}selected{% endif %}>ความดัน</option>
                                        <option value="torque" {% if request.GET.calibration_type == 'torque' %}selected{% endif %}>แรงบิด</option>
                                        <option value="dial_gauge" {% if request.GET.calibration_type == 'dial_gauge' %}selected{% endif %}>Dial Gauge</option>
                                        <option value="balance" {% if request.GET.calibration_type == 'balance' %}selected{% endif %}>Balance</option>
                                        <option value="microwave" {% if request.GET.calibration_type == 'microwave' %}selected{% endif %}>Microwave</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">
                                        <i class="fas fa-flag me-1"></i>สถานะ
                                    </label>
                                    <select class="form-control" name="status_filter">
                                        <option value="">ทั้งหมด</option>
                                        <option value="pending" {% if request.GET.status_filter == 'pending' %}selected{% endif %}>รอปรับเทียบ</option>
                                        <option value="in_progress" {% if request.GET.status_filter == 'in_progress' %}selected{% endif %}>กำลังปรับเทียบ</option>
                                        <option value="passed" {% if request.GET.status_filter == 'passed' %}selected{% endif %}>ผ่านการปรับเทียบ</option>
                                        <option value="cert_issued" {% if request.GET.status_filter == 'cert_issued' %}selected{% endif %}>ออกใบรับรอง</option>
                                        <option value="failed" {% if request.GET.status_filter == 'failed' %}selected{% endif %}>ไม่ผ่านการสอบเทียบ</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">
                                        <i class="fas fa-exclamation-triangle me-1"></i>ความเร่งด่วน
                                    </label>
                                    <select class="form-control" name="priority_filter">
                                        <option value="">ทั้งหมด</option>
                                        <option value="normal" {% if request.GET.priority_filter == 'normal' %}selected{% endif %}>ปกติ</option>
                                        <option value="urgent" {% if request.GET.priority_filter == 'urgent' %}selected{% endif %}>ด่วน</option>
                                        <option value="very_urgent" {% if request.GET.priority_filter == 'very_urgent' %}selected{% endif %}>ด่วนมาก</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="btn-group" role="group">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-search me-1"></i>ค้นหา
                                        </button>
                                        <a href="{% url 'calibrate-dashboard' %}" class="btn btn-secondary">
                                            <i class="fas fa-times me-1"></i>ล้างการกรอง
                                        </a>
                                        <a href="{% url 'select-machine-for-calibration' %}" class="btn btn-success">
                                            <i class="fas fa-plus me-1"></i>เพิ่มบันทึกใหม่
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ตารางแสดงรายการการปรับเทียบทั้งหมด -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list me-2"></i>
                            รายการบันทึกการปรับเทียบทั้งหมด ({{ all_calibrations|length }} รายการ)
                        </h5>
                        <div class="btn-group" role="group">
                            <a href="{% url 'calibrate-force-list' %}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-weight me-1"></i>แรง
                            </a>
                            <a href="{% url 'calibrate-pressure-list' %}" class="btn btn-outline-success btn-sm">
                                <i class="fas fa-tachometer-alt me-1"></i>ความดัน
                            </a>
                            <a href="{% url 'calibrate-torque-list' %}" class="btn btn-outline-warning btn-sm">
                                <i class="fas fa-cog me-1"></i>แรงบิด
                            </a>
                            <button type="button" class="btn btn-outline-danger btn-sm" id="deleteSelectedBtn" style="display: none;">
                                <i class="fas fa-trash me-1"></i>ลบที่เลือก
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if all_calibrations %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAll" class="form-check-input">
                                        </th>
                                        <th>ลำดับ</th>
                                        <th>ประเภทการปรับเทียบ</th>
                                        <th>ชื่อเครื่องมือ</th>
                                        <th>รุ่น</th>
                                        <th>หมายเลขเครื่อง</th>
                                        <th>วันที่ปรับเทียบ</th>
                                        <th>วันที่ครบกำหนดถัดไป</th>
                                        <th>สถานะการปรับเทียบ</th>
                                        <th>ระดับความเร่งด่วน</th>
                                        <th>จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cal in all_calibrations %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" class="form-check-input calibration-checkbox" 
                                                   data-id="{{ cal.id }}" data-type="{{ cal.type }}">
                                        </td>
                                        <td>{{ forloop.counter }}</td>
                                        <td>
                                            {% if cal.type == 'force' %}
                                                <span class="badge bg-primary">{{ cal.type_name }}</span>
                                            {% elif cal.type == 'pressure' %}
                                                <span class="badge bg-success">{{ cal.type_name }}</span>
                                            {% elif cal.type == 'torque' %}
                                                <span class="badge bg-warning">{{ cal.type_name }}</span>
                                            {% elif cal.type == 'dial_gauge' %}
                                                <span class="badge bg-secondary">{{ cal.type_name }}</span>
                                            {% elif cal.type == 'balance' %}
                                                <span class="badge bg-dark">{{ cal.type_name }}</span>
                                            {% elif cal.type == 'microwave' %}
                                                <span class="badge bg-danger">{{ cal.type_name }}</span>
                                            {% endif %}
                                        </td>
                                        <td><strong>{{ cal.machine_name }}</strong></td>
                                        <td>{{ cal.machine_model }}</td>
                                        <td><code>{{ cal.serial_number }}</code></td>
                                        <td>
                                            {% if cal.update_date %}
                                                {{ cal.update_date|date:"d/m/Y" }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if cal.next_due %}
                                                {{ cal.next_due|date:"d/m/Y" }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if cal.status == 'pending' %}
                                                <span class="badge bg-warning">รอปรับเทียบ</span>
                                            {% elif cal.status == 'in_progress' %}
                                                <span class="badge bg-info">กำลังปรับเทียบ</span>
                                            {% elif cal.status == 'passed' %}
                                                <span class="badge bg-success">ผ่านการปรับเทียบ</span>
                                            {% elif cal.status == 'cert_issued' %}
                                                <span class="badge bg-primary">ออกใบรับรอง</span>
                                            {% elif cal.status == 'failed' %}
                                                <span class="badge bg-danger">ไม่ผ่านการสอบเทียบ</span>
                                            {% elif cal.status == 'not_set' %}
                                                <span class="badge bg-secondary">ยังไม่ตั้งค่า</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ cal.status }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if cal.priority == 'normal' %}
                                                <span class="badge bg-secondary">ปกติ</span>
                                            {% elif cal.priority == 'urgent' %}
                                                <span class="badge bg-warning">ด่วน</span>
                                            {% elif cal.priority == 'very_urgent' %}
                                                <span class="badge bg-danger">ด่วนมาก</span>
                                            {% else %}
                                                <span class="badge bg-secondary">ปกติ</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                {% if cal.type == 'force' %}
                                                    <a href="{% url 'calibrate-force-edit' cal.id %}" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    {% if user.is_staff or user.is_superuser %}
                                                        <button type="button" class="btn btn-sm btn-outline-warning priority-btn" 
                                                                data-id="{{ cal.id }}" data-type="{{ cal.type }}" 
                                                                data-name="{{ cal.machine_name }}" data-current-priority="{{ cal.priority }}"
                                                                title="เปลี่ยนระดับความเร่งด่วน">
                                                            <i class="fas fa-arrow-up"></i>
                                                        </button>
                                                        {% if cal.status != 'closed' %}
                                                            <button type="button" class="btn btn-sm btn-outline-secondary close-work-btn" 
                                                                    data-id="{{ cal.id }}" data-type="{{ cal.type }}" 
                                                                    data-name="{{ cal.machine_name }}" data-current-status="{{ cal.status }}"
                                                                    title="ปิดงาน">
                                                                <i class="fas fa-check-circle"></i>
                                                            </button>
                                                        {% endif %}
                                                    {% endif %}
                                                    <button type="button" class="btn btn-sm btn-outline-danger delete-btn" 
                                                            data-id="{{ cal.id }}" data-type="{{ cal.type }}" 
                                                            data-name="{{ cal.machine_name }}">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                {% elif cal.type == 'pressure' %}
                                                    <a href="{% url 'calibrate-pressure-edit' cal.id %}" class="btn btn-sm btn-outline-success">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    {% if user.is_staff or user.is_superuser %}
                                                        <button type="button" class="btn btn-sm btn-outline-warning priority-btn" 
                                                                data-id="{{ cal.id }}" data-type="{{ cal.type }}" 
                                                                data-name="{{ cal.machine_name }}" data-current-priority="{{ cal.priority }}"
                                                                title="เปลี่ยนระดับความเร่งด่วน">
                                                            <i class="fas fa-arrow-up"></i>
                                                        </button>
                                                        {% if cal.status != 'closed' %}
                                                            <button type="button" class="btn btn-sm btn-outline-secondary close-work-btn" 
                                                                    data-id="{{ cal.id }}" data-type="{{ cal.type }}" 
                                                                    data-name="{{ cal.machine_name }}" data-current-status="{{ cal.status }}"
                                                                    title="ปิดงาน">
                                                                <i class="fas fa-check-circle"></i>
                                                            </button>
                                                        {% endif %}
                                                    {% endif %}
                                                    <button type="button" class="btn btn-sm btn-outline-danger delete-btn" 
                                                            data-id="{{ cal.id }}" data-type="{{ cal.type }}" 
                                                            data-name="{{ cal.machine_name }}">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                {% elif cal.type == 'torque' %}
                                                    <a href="{% url 'calibrate-torque-edit' cal.id %}" class="btn btn-sm btn-outline-warning">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    {% if user.is_staff or user.is_superuser %}
                                                        <button type="button" class="btn btn-sm btn-outline-warning priority-btn" 
                                                                data-id="{{ cal.id }}" data-type="{{ cal.type }}" 
                                                                data-name="{{ cal.machine_name }}" data-current-priority="{{ cal.priority }}"
                                                                title="เปลี่ยนระดับความเร่งด่วน">
                                                            <i class="fas fa-arrow-up"></i>
                                                        </button>
                                                        {% if cal.status != 'closed' %}
                                                            <button type="button" class="btn btn-sm btn-outline-secondary close-work-btn" 
                                                                    data-id="{{ cal.id }}" data-type="{{ cal.type }}" 
                                                                    data-name="{{ cal.machine_name }}" data-current-status="{{ cal.status }}"
                                                                    title="ปิดงาน">
                                                                <i class="fas fa-check-circle"></i>
                                                            </button>
                                                        {% endif %}
                                                    {% endif %}
                                                    <button type="button" class="btn btn-sm btn-outline-danger delete-btn" 
                                                            data-id="{{ cal.id }}" data-type="{{ cal.type }}" 
                                                            data-name="{{ cal.machine_name }}">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">ยังไม่มีบันทึกการปรับเทียบ</h5>
                            <p class="text-muted">เริ่มต้นด้วยการเพิ่มบันทึกการปรับเทียบใหม่</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- คำแนะนำ -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> คำแนะนำการใช้งาน</h6>
                    <ul class="mb-0">
                        <li>ตารางแสดงรายการบันทึกการปรับเทียบทั้งหมดในระบบ</li>
                        <li>สามารถเพิ่มบันทึกการปรับเทียบใหม่ได้จากปุ่มด้านบน</li>
                        <li>สถานะจะแสดงสีตามระยะเวลาการปรับเทียบถัดไป</li>
                        <li>ระดับความเร่งด่วนช่วยจัดลำดับความสำคัญ</li>
                        <li>สามารถแก้ไขหรือลบบันทึกได้จากปุ่มจัดการ</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger"></i> ยืนยันการลบ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>คุณต้องการลบบันทึกการปรับเทียบ <strong id="deleteItemName"></strong> ใช่หรือไม่?</p>
                <p class="text-danger"><small>การดำเนินการนี้ไม่สามารถยกเลิกได้</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash"></i> ลบ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Batch Delete Confirmation Modal -->
<div class="modal fade" id="batchDeleteModal" tabindex="-1" aria-labelledby="batchDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batchDeleteModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger"></i> ยืนยันการลบหลายรายการ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>คุณต้องการลบบันทึกการปรับเทียบที่เลือก <strong id="selectedCount"></strong> รายการ ใช่หรือไม่?</p>
                <p class="text-danger"><small>การดำเนินการนี้ไม่สามารถยกเลิกได้</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-danger" id="confirmBatchDeleteBtn">
                    <i class="fas fa-trash"></i> ลบทั้งหมด
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal สำหรับยืนยันการเพิ่มระดับความเร่งด่วน -->
<div class="modal fade" id="priorityModal" tabindex="-1" aria-labelledby="priorityModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="priorityModalLabel">
                    <i class="fas fa-cog me-2"></i>เปลี่ยนระดับความเร่งด่วน
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    เลือกระดับความเร่งด่วนสำหรับเครื่องมือ: <strong id="machineNameInModal"></strong>
                </div>
                
                <div class="current-priority mb-3">
                    <label class="form-label">ระดับความเร่งด่วนปัจจุบัน:</label>
                    <div id="currentPriorityBadge"></div>
                </div>
                
                <div class="priority-selection">
                    <label class="form-label">เลือกระดับความเร่งด่วนใหม่:</label>
                    <div class="priority-options">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="selectedPriority" id="priorityNormal" value="normal">
                            <label class="form-check-label" for="priorityNormal">
                                <div class="d-flex align-items-center">
                                    <div class="priority-icon me-2">
                                        <i class="fas fa-circle text-secondary"></i>
                                    </div>
                                    <div class="priority-content">
                                        <strong>ปกติ</strong>
                                        <small class="text-muted d-block">การปรับเทียบทั่วไป ไม่มีความเร่งด่วน</small>
                                    </div>
                                </div>
                            </label>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="selectedPriority" id="priorityUrgent" value="urgent">
                            <label class="form-check-label" for="priorityUrgent">
                                <div class="d-flex align-items-center">
                                    <div class="priority-icon me-2">
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                    </div>
                                    <div class="priority-content">
                                        <strong>ด่วน</strong>
                                        <small class="text-muted d-block">มีความเร่งด่วน ต้องดำเนินการเร็ว</small>
                                    </div>
                                </div>
                            </label>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="selectedPriority" id="priorityVeryUrgent" value="very_urgent">
                            <label class="form-check-label" for="priorityVeryUrgent">
                                <div class="d-flex align-items-center">
                                    <div class="priority-icon me-2">
                                        <i class="fas fa-exclamation-circle text-danger"></i>
                                    </div>
                                    <div class="priority-content">
                                        <strong>ด่วนมาก</strong>
                                        <small class="text-muted d-block">มีความเร่งด่วนสูงสุด ต้องดำเนินการทันที</small>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>ยกเลิก
                </button>
                <button type="button" class="btn btn-warning" id="confirmPriorityBtn">
                    <i class="fas fa-check me-1"></i>ยืนยันการเปลี่ยนระดับ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal สำหรับยืนยันการปิดงาน -->
<div class="modal fade" id="closeWorkModal" tabindex="-1" aria-labelledby="closeWorkModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="closeWorkModalLabel">
                    <i class="fas fa-check-circle me-2"></i>ปิดงาน
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    คุณต้องการปิดงานสำหรับเครื่องมือ: <strong id="closeWorkMachineName"></strong>
                </div>
                
                <div class="current-status mb-3">
                    <label class="form-label">สถานะปัจจุบัน:</label>
                    <div id="currentStatusBadge"></div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>หมายเหตุ:</strong> เมื่อปิดงานแล้ว รายการนี้จะไม่แสดงในตารางหลัก แต่จะยังคงแสดงในหน้ารายงานผล
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>ยกเลิก
                </button>
                <button type="button" class="btn btn-success" id="confirmCloseWorkBtn">
                    <i class="fas fa-check-circle me-1"></i>ยืนยันการปิดงาน
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Select All functionality
    const selectAllCheckbox = document.getElementById('selectAll');
    const calibrationCheckboxes = document.querySelectorAll('.calibration-checkbox');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');

    selectAllCheckbox.addEventListener('change', function() {
        calibrationCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateDeleteButton();
    });

    calibrationCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateDeleteButton();
            updateSelectAll();
        });
    });

    function updateDeleteButton() {
        const checkedBoxes = document.querySelectorAll('.calibration-checkbox:checked');
        if (checkedBoxes.length > 0) {
            deleteSelectedBtn.style.display = 'inline-block';
        } else {
            deleteSelectedBtn.style.display = 'none';
        }
    }

    function updateSelectAll() {
        const checkedBoxes = document.querySelectorAll('.calibration-checkbox:checked');
        const totalBoxes = calibrationCheckboxes.length;
        selectAllCheckbox.checked = checkedBoxes.length === totalBoxes;
        selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < totalBoxes;
    }

    // Individual delete functionality
    const deleteButtons = document.querySelectorAll('.delete-btn');
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    const deleteItemName = document.getElementById('deleteItemName');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const type = this.getAttribute('data-type');
            const name = this.getAttribute('data-name');
            
            deleteItemName.textContent = name;
            confirmDeleteBtn.onclick = function() {
                deleteCalibration(id, type);
            };
            
            deleteModal.show();
        });
    });

    // Batch delete functionality
    deleteSelectedBtn.addEventListener('click', function() {
        const checkedBoxes = document.querySelectorAll('.calibration-checkbox:checked');
        const selectedCount = document.getElementById('selectedCount');
        const batchDeleteModal = new bootstrap.Modal(document.getElementById('batchDeleteModal'));
        
        selectedCount.textContent = checkedBoxes.length;
        
        document.getElementById('confirmBatchDeleteBtn').onclick = function() {
            batchDeleteCalibrations(checkedBoxes);
        };
        
        batchDeleteModal.show();
    });

    function deleteCalibration(id, type) {
        let deleteUrl;
        switch(type) {
            case 'force':
                deleteUrl = `/calibrate/force/${id}/delete/`;
                break;
            case 'pressure':
                deleteUrl = `/calibrate/pressure/${id}/delete/`;
                break;
            case 'torque':
                deleteUrl = `/calibrate/torque/${id}/delete/`;
                break;
        }

        fetch(deleteUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('เกิดข้อผิดพลาดในการลบข้อมูล');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('เกิดข้อผิดพลาดในการลบข้อมูล');
        });
    }

    function batchDeleteCalibrations(checkedBoxes) {
        const deletePromises = [];
        
        checkedBoxes.forEach(checkbox => {
            const id = checkbox.getAttribute('data-id');
            const type = checkbox.getAttribute('data-type');
            
            let deleteUrl;
            switch(type) {
                case 'force':
                    deleteUrl = `/calibrate/force/${id}/delete/`;
                    break;
                case 'pressure':
                    deleteUrl = `/calibrate/pressure/${id}/delete/`;
                    break;
                case 'torque':
                    deleteUrl = `/calibrate/torque/${id}/delete/`;
                    break;
            }

            deletePromises.push(
                fetch(deleteUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                })
            );
        });

        Promise.all(deletePromises)
            .then(responses => {
                const allSuccessful = responses.every(response => response.ok);
                if (allSuccessful) {
                    location.reload();
                } else {
                    alert('เกิดข้อผิดพลาดในการลบข้อมูลบางรายการ');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('เกิดข้อผิดพลาดในการลบข้อมูล');
            });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // ========== Priority Increase Functionality ==========
    
    // Priority button click handlers
    document.addEventListener('click', function(e) {
        if (e.target.closest('.priority-btn')) {
            const btn = e.target.closest('.priority-btn');
            const id = btn.getAttribute('data-id');
            const type = btn.getAttribute('data-type');
            const name = btn.getAttribute('data-name');
            const currentPriority = btn.getAttribute('data-current-priority');
            
            // Set modal data
            document.getElementById('machineNameInModal').textContent = name;
            
            // Show current priority
            const currentBadge = document.getElementById('currentPriorityBadge');
            currentBadge.innerHTML = getPriorityBadge(currentPriority);
            
            // Set current priority as selected
            document.querySelector(`input[name="selectedPriority"][value="${currentPriority}"]`).checked = true;
            
            // Set confirm button data
            const confirmBtn = document.getElementById('confirmPriorityBtn');
            confirmBtn.setAttribute('data-id', id);
            confirmBtn.setAttribute('data-type', type);
            
            // Show modal
            const priorityModal = new bootstrap.Modal(document.getElementById('priorityModal'));
            priorityModal.show();
        }
    });

    // Confirm priority change
    document.getElementById('confirmPriorityBtn').addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        const type = this.getAttribute('data-type');
        
        // Get selected priority
        const selectedPriority = document.querySelector('input[name="selectedPriority"]:checked');
        if (!selectedPriority) {
            alert('กรุณาเลือกระดับความเร่งด่วน');
            return;
        }
        
        const newPriority = selectedPriority.value;
        
        // Send request to change priority
        fetch(`/calibrate/increase-priority/${type}/${id}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                'new_priority': newPriority
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('เปลี่ยนระดับความเร่งด่วนสำเร็จ');
                location.reload();
            } else {
                alert('เกิดข้อผิดพลาด: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('เกิดข้อผิดพลาดในการเปลี่ยนระดับความเร่งด่วน');
        });
        
        // Close modal
        const priorityModal = bootstrap.Modal.getInstance(document.getElementById('priorityModal'));
        priorityModal.hide();
    });

    // Helper functions
    function getPriorityBadge(priority) {
        switch(priority) {
            case 'normal':
                return '<span class="badge bg-secondary">ปกติ</span>';
            case 'urgent':
                return '<span class="badge bg-warning">ด่วน</span>';
            case 'very_urgent':
                return '<span class="badge bg-danger">ด่วนมาก</span>';
            default:
                return '<span class="badge bg-secondary">ปกติ</span>';
        }
    }

    // ========== Close Work Functionality ==========
    
    // Close work button click handlers
    document.addEventListener('click', function(e) {
        if (e.target.closest('.close-work-btn')) {
            const btn = e.target.closest('.close-work-btn');
            const id = btn.getAttribute('data-id');
            const type = btn.getAttribute('data-type');
            const name = btn.getAttribute('data-name');
            const currentStatus = btn.getAttribute('data-current-status');
            
            // Set modal data
            document.getElementById('closeWorkMachineName').textContent = name;
            
            // Show current status
            const currentBadge = document.getElementById('currentStatusBadge');
            currentBadge.innerHTML = getStatusBadge(currentStatus);
            
            // Set confirm button data
            const confirmBtn = document.getElementById('confirmCloseWorkBtn');
            confirmBtn.setAttribute('data-id', id);
            confirmBtn.setAttribute('data-type', type);
            
            // Show modal
            const closeWorkModal = new bootstrap.Modal(document.getElementById('closeWorkModal'));
            closeWorkModal.show();
        }
    });

    // Confirm close work
    document.getElementById('confirmCloseWorkBtn').addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        const type = this.getAttribute('data-type');
        
        // Send request to close work
        fetch(`/calibrate/close-work/${type}/${id}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('ปิดงานสำเร็จ');
                location.reload();
            } else {
                alert('เกิดข้อผิดพลาด: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('เกิดข้อผิดพลาดในการปิดงาน');
        });
        
        // Close modal
        const closeWorkModal = bootstrap.Modal.getInstance(document.getElementById('closeWorkModal'));
        closeWorkModal.hide();
    });

    // Helper function for status badge
    function getStatusBadge(status) {
        switch(status) {
            case 'pending':
                return '<span class="badge bg-warning">รอปรับเทียบ</span>';
            case 'in_progress':
                return '<span class="badge bg-info">กำลังปรับเทียบ</span>';
            case 'passed':
                return '<span class="badge bg-success">ผ่านการปรับเทียบ</span>';
            case 'cert_issued':
                return '<span class="badge bg-success">ออกใบรับรอง</span>';
            case 'failed':
                return '<span class="badge bg-danger">ไม่ผ่านการสอบเทียบ</span>';
            case 'closed':
                return '<span class="badge bg-secondary">ปิดงาน</span>';
            default:
                return '<span class="badge bg-secondary">' + status + '</span>';
        }
    }
});
</script>
{% endblock %} 